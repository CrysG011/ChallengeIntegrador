require("dotenv").config();const express=require("express"),app=express(),path=require("path"),methodOverride=require("method-override"),sequelize=require("./src/models/db.js"),model=require("./src/models/User"),modelCart=require("./src/models/Cart"),session=require("cookie-session"),isLogin=(app.use(session({keys:["2f63f1edd8b2c3926f52154eb4672e43a0563f0fcc36c98166f829f1c77bac6e","d6a7cd2a7371b1a15d543196979ff74fdb027023ebf187d5d329be11055c77fd"]})),(req,res,next)=>{if(!req.session.userId)return req.session.returnTo=req.originalUrl,res.redirect("/auth/login");next()}),isAdmin=async(req,res,next)=>{try{var user=await model.findOne({where:{id:req.session.userId}});user&&(1==user.admin?next():res.send("No tienes permisos para acceder a esta pÃ¡gina"))}catch(error){res.send(error),console.log(error)}},helmet=require("helmet"),PORT=(app.use(helmet.contentSecurityPolicy({directives:{defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'","cdn.jsdelivr.net"],styleSrc:["'self'","'unsafe-inline'","cdn.jsdelivr.net"],imgSrc:["'self'","data:"],connectSrc:["'self'","cdn.jsdelivr.net"],fontSrc:["'self'"],objectSrc:["'none'"],mediaSrc:["'self'"],frameSrc:["'none'"],baseUri:["'self'"],formAction:["'self'"],frameAncestors:["'none'"]}})),app.set("view engine","ejs"),app.set("views",path.join(__dirname,"/src/views")),app.use(methodOverride("_method")),app.use(express.urlencoded({extended:!1})),app.use(express.static(path.join(__dirname,"/public"))),app.use(require("./src/routes/mainRoutes.js")),app.use("/admin/",isLogin,isAdmin,require("./src/routes/admin/productsRoutes.js")),app.use("/shop",require("./src/routes/shop/shopRoutes.js")),app.use("/auth",require("./src/routes/auth/authRoutes.js")),app.use((req,res)=>{res.status(404).render("error")}),process.env.PORT||3e3);app.listen(PORT,async()=>{try{await sequelize.sync({alter:!0})}catch(error){console.log(error)}console.log("http://localhost:"+PORT)});